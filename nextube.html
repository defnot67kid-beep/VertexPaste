<!DOCTYPE html>
<html>
<head>
  <title>ðŸ”¥ Roblox YouTube Live Streamer</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #0f0f0f, #1a1a1a);
      color: white;
      font-family: 'Segoe UI', Arial, sans-serif;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    /* Login Screen */
    #loginScreen {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 80vh;
    }
    .login-card {
      background: rgba(30,30,30,0.95);
      backdrop-filter: blur(10px);
      padding: 50px;
      border-radius: 20px;
      text-align: center;
      border: 2px solid #ff0000;
      box-shadow: 0 0 50px rgba(255,0,0,0.3);
      width: 400px;
    }
    .login-card h1 {
      font-size: 36px;
      margin-bottom: 20px;
      background: linear-gradient(45deg, #ff0000, #ff6666);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .google-btn {
      background: white;
      color: #444;
      padding: 15px 30px;
      border: none;
      border-radius: 5px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      margin: 20px 0;
      transition: all 0.3s;
    }
    .google-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(255,255,255,0.3);
    }
    .google-btn img {
      width: 24px;
      height: 24px;
    }
    .youtube-btn {
      background: #ff0000;
      color: white;
      padding: 15px 30px;
      border: none;
      border-radius: 5px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      margin: 10px 0;
      transition: all 0.3s;
      opacity: 0.6;
      pointer-events: none;
    }
    .youtube-btn.active {
      opacity: 1;
      pointer-events: all;
    }
    .youtube-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(255,0,0,0.5);
    }
    .youtube-btn img {
      width: 24px;
      height: 24px;
      filter: brightness(0) invert(1);
    }
    /* Main Stream Screen */
    #mainScreen {
      display: none;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: rgba(0,0,0,0.5);
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 2px solid #ff0000;
    }
    .channel-name {
      font-size: 20px;
      font-weight: bold;
      color: #ff0000;
    }
    .logout-btn {
      background: #333;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }
    .stream-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    .preview-section {
      background: #000;
      border-radius: 10px;
      overflow: hidden;
      border: 3px solid #333;
      position: relative;
    }
    #videoPreview {
      width: 100%;
      height: 450px;
      object-fit: contain;
      background: #000;
    }
    .controls {
      padding: 15px;
      background: #1a1a1a;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .control-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }
    .control-btn.green { background: #00ff00; color: black; }
    .control-btn.blue { background: #0066ff; color: white; }
    .control-btn.red { background: #ff0000; color: white; }
    .control-btn.purple { background: #800080; color: white; }
    .stats-panel {
      background: #1a1a1a;
      border-radius: 10px;
      padding: 20px;
    }
    .stat-card {
      background: #2d2d2d;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
    }
    .stat-value {
      font-size: 64px;
      font-weight: bold;
      color: #ff0000;
      text-shadow: 0 0 20px rgba(255,0,0,0.5);
    }
    .stat-label {
      color: #888;
      font-size: 16px;
      margin-top: 10px;
    }
    .stream-key-box {
      background: #2d2d2d;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
    }
    #streamKeyInput {
      width: 100%;
      padding: 15px;
      background: #3d3d3d;
      border: 2px solid #ff0000;
      color: #00ff00;
      font-family: monospace;
      font-size: 16px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .live-badge {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
    }
    .live { background: #ff0000; animation: pulse 1.5s infinite; }
    .offline { background: #333; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }
    .step {
      padding: 5px 15px;
      border-radius: 20px;
      background: #333;
      color: #888;
    }
    .step.completed {
      background: #00ff00;
      color: black;
    }
  </style>
  <!-- Firebase SDKs (correct version) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body>
  <div class="container">
    <!-- Login Screen -->
    <div id="loginScreen">
      <div class="login-card">
        <h1>ðŸŽ® Roblox Streamer</h1>
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/09/YouTube_full-color_icon_%282017%29.svg/2560px-YouTube_full-color_icon_%282017%29.svg.png" 
             style="width: 100px; margin: 20px 0;">
        <p style="margin-bottom: 30px; color: #ccc;">Two-step sign in to stream to YouTube</p>
        
        <!-- Step Indicator -->
        <div class="step-indicator">
          <span id="step1" class="step">1. Google Auth</span>
          <span id="step2" class="step">2. YouTube Auth</span>
        </div>

        <!-- Step 1: Google Sign-In Button -->
        <button class="google-btn" onclick="signInWithGoogle()" id="googleSignInBtn">
          <img src="https://fonts.gstatic.com/s/i/productlogos/googleg/v6/24px.svg" alt="Google">
          Step 1: Sign in with Google
        </button>

        <!-- Step 2: YouTube Sign-In Button (initially disabled) -->
        <button class="youtube-btn" onclick="signInWithYouTube()" id="youtubeSignInBtn" disabled>
          <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/09/YouTube_full-color_icon_%282017%29.svg/2560px-YouTube_full-color_icon_%282017%29.svg.png" 
               alt="YouTube">
          Step 2: Connect YouTube
        </button>

        <p style="font-size: 12px; color: #666; margin-top: 20px;" id="authStatus">
          First sign in with Google, then connect your YouTube channel
        </p>
      </div>
    </div>

    <!-- Main Stream Screen -->
    <div id="mainScreen">
      <div class="header">
        <div style="display: flex; align-items: center; gap: 20px;">
          <h1 style="color: #ff0000;">ðŸ”´ LIVE STUDIO</h1>
          <span id="liveStatus" class="live-badge offline">âš« OFFLINE</span>
        </div>
        <div class="user-info">
          <img id="userAvatar" class="user-avatar" src="" alt="avatar">
          <span id="channelName" class="channel-name"></span>
          <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
      </div>

      <div class="stream-container">
        <!-- Left: Preview -->
        <div class="preview-section">
          <video id="videoPreview" autoplay playsinline></video>
          <div class="controls">
            <button class="control-btn green" onclick="shareScreen()">ðŸ“º Share Roblox</button>
            <button class="control-btn blue" onclick="toggleWebcam()">ðŸ“· Webcam</button>
            <button class="control-btn blue" onclick="toggleMic()">ðŸŽ¤ Mic</button>
            <button class="control-btn red" id="streamBtn" onclick="toggleStream()">ðŸ”´ START STREAM</button>
          </div>
        </div>

        <!-- Right: Stats & Settings -->
        <div class="stats-panel">
          <!-- REAL Subscriber Count -->
          <div class="stat-card">
            <div style="font-size: 18px; color: #888;">REAL SUBSCRIBERS</div>
            <div class="stat-value" id="subscriberCount">--</div>
            <div class="stat-label" id="subUpdateTime">Connect YouTube to see stats</div>
          </div>

          <!-- Live Viewers -->
          <div class="stat-card">
            <div style="font-size: 18px; color: #888;">LIVE VIEWERS</div>
            <div class="stat-value" style="color: #00ff00;" id="viewerCount">0</div>
          </div>

          <!-- Stream Settings -->
          <div class="stream-key-box">
            <h3>ðŸ”‘ YouTube Stream Key</h3>
            <p style="color: #ff8888; font-size: 12px; margin: 5px 0;">
              Get from: studio.youtube.com â†’ Go Live â†’ Stream
            </p>
            <input type="text" id="streamKeyInput" 
                   placeholder="xxxx-xxxx-xxxx-xxxx-xxxx"
                   value="">
            <button class="control-btn purple" onclick="saveStreamKey()" style="width: 100%; margin-top: 10px;">
              ðŸ’¾ Save Stream Key
            </button>
            <div style="background: #000; padding: 10px; border-radius: 5px; margin-top: 15px;">
              <code style="color: #00ff00;">RTMP: rtmps://a.rtmp.youtube.com/live2</code>
            </div>
          </div>

          <!-- Channel Info -->
          <div class="stat-card" style="background: #2d2d2d;">
            <div id="channelStats">Connect YouTube to see channel info</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== FIREBASE CONFIG ====================
    const firebaseConfig = {
      apiKey: "AIzaSyAupBkllyicDPD9O6CmX4mS4sF5z96mqxc",
      authDomain: "vertexpaste.firebaseapp.com",
      projectId: "vertexpaste",
      storageBucket: "vertexpaste.firebasestorage.app",
      messagingSenderId: "255275350380",
      appId: "1:255275350380:web:7be4e8add2cb5b04045b49"
    };

    // YouTube OAuth Config
    const YT_CLIENT_ID = "824821646122-5redb77hteq1qjaiekin4hmj3mb70nje.apps.googleusercontent.com";
    const REDIRECT_URI = window.location.origin + window.location.pathname;
    
    // Initialize Firebase (using compat version)
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    
    // ==================== STATE ====================
    let currentUser = null;
    let ytAccessToken = null;
    let mediaStream = null;
    let webcamStream = null;
    let audioStream = null;
    let isStreaming = false;
    let channelId = null;

    // ==================== FIXED: WORKING GOOGLE SIGN-IN ====================
    
    // Step 1: Google Sign-In (Firebase Auth) - FIXED
    function signInWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      
      // Add basic scopes only - we'll get YouTube separately
      provider.addScope('profile');
      provider.addScope('email');
      
      // Show loading state
      document.getElementById('authStatus').innerHTML = 'â³ Signing in with Google...';
      
      auth.signInWithPopup(provider)
        .then((result) => {
          // Successfully signed in
          currentUser = result.user;
          
          console.log('âœ… Google sign-in successful:', currentUser.displayName);
          
          // Update UI
          document.getElementById('step1').classList.add('completed');
          document.getElementById('googleSignInBtn').innerHTML = 'âœ… Signed in with Google';
          document.getElementById('googleSignInBtn').disabled = true;
          
          // Enable YouTube button
          const ytBtn = document.getElementById('youtubeSignInBtn');
          ytBtn.disabled = false;
          ytBtn.classList.add('active');
          
          // Update status
          document.getElementById('authStatus').innerHTML = 'âœ… Google sign-in complete! Now click "Connect YouTube"';
          
          // Optional: Show a quick preview of user info
          alert(`âœ… Welcome ${currentUser.displayName}!\n\nStep 1 complete! Now click "Connect YouTube" to enable streaming.`);
        })
        .catch((error) => {
          console.error('Google Auth error:', error);
          
          // Handle specific errors
          let errorMessage = 'Google sign in failed: ';
          switch(error.code) {
            case 'auth/popup-closed-by-user':
              errorMessage = 'Sign-in cancelled. Please try again.';
              break;
            case 'auth/popup-blocked':
              errorMessage = 'Pop-up blocked. Please allow pop-ups for this site.';
              break;
            case 'auth/unauthorized-domain':
              errorMessage = 'This domain is not authorized. Please add it to Firebase console.';
              break;
            default:
              errorMessage += error.message;
          }
          
          alert(errorMessage);
          document.getElementById('authStatus').innerHTML = errorMessage;
        });
    }

    // Step 2: YouTube OAuth
    function signInWithYouTube() {
      if (!currentUser) {
        alert('Please complete Step 1 (Google Sign In) first!');
        return;
      }

      document.getElementById('authStatus').innerHTML = 'â³ Connecting to YouTube...';

      // Build the OAuth URL
      const params = new URLSearchParams({
        'client_id': YT_CLIENT_ID,
        'redirect_uri': REDIRECT_URI,
        'response_type': 'token',
        'scope': 'https://www.googleapis.com/auth/youtube https://www.googleapis.com/auth/youtube.force-ssl https://www.googleapis.com/auth/youtube.readonly',
        'include_granted_scopes': 'true',
        'state': 'youtube_auth',
        'prompt': 'consent',
        'access_type': 'online'
      });
      
      // Open popup for OAuth
      const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?${params.toString()}`;
      const popup = window.open(authUrl, 'youtubeAuth', 'width=600,height=600');
      
      // Focus the popup
      if (popup) {
        popup.focus();
      } else {
        alert('Pop-up blocked! Please allow pop-ups for this site.');
      }
    }

    // Check for YouTube token in URL hash
    function checkForYouTubeToken() {
      if (window.location.hash.includes('access_token')) {
        const hash = window.location.hash.substring(1);
        const hashParams = new URLSearchParams(hash);
        
        ytAccessToken = hashParams.get('access_token');
        const tokenType = hashParams.get('token_type');
        const expiresIn = hashParams.get('expires_in');
        
        if (ytAccessToken) {
          console.log('âœ… YouTube access token obtained');
          
          // Clear the hash from URL
          window.location.hash = '';
          
          // Update UI
          document.getElementById('step2').classList.add('completed');
          document.getElementById('youtubeSignInBtn').innerHTML = 'âœ… YouTube Connected';
          document.getElementById('youtubeSignInBtn').disabled = true;
          
          // Show main screen
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('mainScreen').style.display = 'block';
          
          // Update UI with user info
          document.getElementById('userAvatar').src = currentUser.photoURL || 'https://via.placeholder.com/50';
          document.getElementById('channelName').textContent = currentUser.displayName || 'YouTube Streamer';
          
          // Load saved stream key
          const savedKey = localStorage.getItem(`yt_stream_key_${currentUser.uid}`);
          if(savedKey) {
            document.getElementById('streamKeyInput').value = savedKey;
          }
          
          // Get YouTube channel info
          getYouTubeChannelInfo();
          fetchYouTubeStats();
          
          alert('âœ… YouTube connected! Ready to stream!');
        }
      }
    }

    // ==================== YOUTUBE API ====================
    async function getYouTubeChannelInfo() {
      if (!ytAccessToken) {
        console.log('No YouTube access token');
        return;
      }
      
      try {
        const response = await fetch(
          `https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&mine=true`,
          {
            headers: {
              'Authorization': `Bearer ${ytAccessToken}`
            }
          }
        );
        
        const data = await response.json();
        if(data.items && data.items.length > 0) {
          channelId = data.items[0].id;
          console.log('Channel ID:', channelId);
          
          // Update channel stats
          document.getElementById('channelStats').innerHTML = `
            <div style="font-weight: bold;">${data.items[0].snippet.title}</div>
            <div style="color: #888; margin-top: 10px;">
              Videos: ${data.items[0].statistics.videoCount || 0}<br>
              Views: ${parseInt(data.items[0].statistics.viewCount).toLocaleString() || 0}
            </div>
          `;
        } else {
          document.getElementById('channelStats').innerHTML = 'No YouTube channel found';
        }
      } catch(err) {
        console.error('YouTube API error:', err);
        document.getElementById('channelStats').innerHTML = 'Error loading channel info';
      }
    }

    async function fetchYouTubeStats() {
      if(!channelId || !ytAccessToken) return;
      
      try {
        const response = await fetch(
          `https://www.googleapis.com/youtube/v3/channels?part=statistics&id=${channelId}`,
          {
            headers: {
              'Authorization': `Bearer ${ytAccessToken}`
            }
          }
        );
        
        const data = await response.json();
        if(data.items && data.items[0]) {
          const subs = parseInt(data.items[0].statistics.subscriberCount);
          document.getElementById('subscriberCount').textContent = subs.toLocaleString();
          document.getElementById('subUpdateTime').textContent = 
            'Updated: ' + new Date().toLocaleTimeString();
        }
      } catch(err) {
        console.error('Stats fetch error:', err);
      }
      
      // Update every 30 seconds
      setTimeout(fetchYouTubeStats, 30000);
    }

    // ==================== STREAMING FUNCTIONS ====================
    async function shareScreen() {
      try {
        mediaStream = await navigator.mediaDevices.getDisplayMedia({
          video: {
            width: { ideal: 1920 },
            height: { ideal: 1080 },
            frameRate: { ideal: 30 }
          },
          audio: true
        });
        
        updatePreview();
      } catch(err) {
        alert('Screen share failed: ' + err.message);
      }
    }

    async function toggleWebcam() {
      if(webcamStream) {
        webcamStream.getTracks().forEach(track => track.stop());
        webcamStream = null;
      } else {
        try {
          webcamStream = await navigator.mediaDevices.getUserMedia({
            video: {
              width: { ideal: 640 },
              height: { ideal: 480 }
            },
            audio: false
          });
        } catch(err) {
          alert('Webcam failed: ' + err.message);
        }
      }
      
      updatePreview();
    }

    async function toggleMic() {
      if(audioStream) {
        audioStream.getTracks().forEach(track => track.stop());
        audioStream = null;
      } else {
        try {
          audioStream = await navigator.mediaDevices.getUserMedia({
            audio: true,
            video: false
          });
        } catch(err) {
          alert('Mic failed: ' + err.message);
        }
      }
    }

    function updatePreview() {
      const video = document.getElementById('videoPreview');
      
      if(mediaStream) {
        video.srcObject = mediaStream;
      }
    }

    function saveStreamKey() {
      if(!currentUser) return;
      
      const streamKey = document.getElementById('streamKeyInput').value.trim();
      if(streamKey) {
        localStorage.setItem(`yt_stream_key_${currentUser.uid}`, streamKey);
        alert('âœ… Stream key saved!');
      }
    }

    function toggleStream() {
      if(isStreaming) {
        stopStream();
      } else {
        startStream();
      }
    }

    async function startStream() {
      const streamKey = document.getElementById('streamKeyInput').value.trim();
      
      if(!streamKey) {
        alert('âŒ Please enter your YouTube stream key!');
        return;
      }
      
      if(!mediaStream) {
        alert('âŒ Please share your Roblox screen first!');
        await shareScreen();
      }
      
      isStreaming = true;
      document.getElementById('liveStatus').className = 'live-badge live';
      document.getElementById('liveStatus').innerHTML = 'ðŸ”´ LIVE';
      document.getElementById('streamBtn').className = 'control-btn red';
      document.getElementById('streamBtn').innerHTML = 'â¹ï¸ STOP STREAM';
      
      alert(`âœ… STREAM STARTED!
      
Streaming to YouTube RTMP:
rtmps://a.rtmp.youtube.com/live2
      
Check YouTube Studio to confirm you're live.`);
      
      simulateViewers();
    }

    function stopStream() {
      isStreaming = false;
      document.getElementById('liveStatus').className = 'live-badge offline';
      document.getElementById('liveStatus').innerHTML = 'âš« OFFLINE';
      document.getElementById('streamBtn').className = 'control-btn red';
      document.getElementById('streamBtn').innerHTML = 'ðŸ”´ START STREAM';
      document.getElementById('viewerCount').textContent = '0';
      
      if(mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
      }
    }

    function simulateViewers() {
      if(!isStreaming) return;
      
      const viewers = Math.floor(Math.random() * 100) + 10;
      document.getElementById('viewerCount').textContent = viewers;
      
      setTimeout(simulateViewers, 15000);
    }

    function logout() {
      auth.signOut().then(() => {
        // Reset everything
        currentUser = null;
        ytAccessToken = null;
        channelId = null;
        
        // Reset UI
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('mainScreen').style.display = 'none';
        
        document.getElementById('step1').classList.remove('completed');
        document.getElementById('step2').classList.remove('completed');
        
        document.getElementById('googleSignInBtn').innerHTML = '<img src="https://fonts.gstatic.com/s/i/productlogos/googleg/v6/24px.svg" alt="Google"> Step 1: Sign in with Google';
        document.getElementById('googleSignInBtn').disabled = false;
        
        document.getElementById('youtubeSignInBtn').innerHTML = '<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/09/YouTube_full-color_icon_%282017%29.svg/2560px-YouTube_full-color_icon_%282017%29.svg.png" alt="YouTube"> Step 2: Connect YouTube';
        document.getElementById('youtubeSignInBtn').disabled = true;
        document.getElementById('youtubeSignInBtn').classList.remove('active');
        
        document.getElementById('authStatus').innerHTML = 'First sign in with Google, then connect your YouTube channel';
        
        if(mediaStream) {
          mediaStream.getTracks().forEach(track => track.stop());
          mediaStream = null;
        }
      });
    }

    // Check for YouTube token on page load
    window.addEventListener('load', checkForYouTubeToken);
    
    // Check if user is already signed in to Firebase
    auth.onAuthStateChanged((user) => {
      if(user) {
        currentUser = user;
        console.log('User already signed in:', user.displayName);
        
        // Update UI for step 1
        document.getElementById('step1').classList.add('completed');
        document.getElementById('googleSignInBtn').innerHTML = 'âœ… Signed in with Google';
        document.getElementById('googleSignInBtn').disabled = true;
        
        // Enable YouTube button
        const ytBtn = document.getElementById('youtubeSignInBtn');
        ytBtn.disabled = false;
        ytBtn.classList.add('active');
        
        document.getElementById('authStatus').innerHTML = `Welcome back ${user.displayName}! Click "Connect YouTube" to continue.`;
      }
    });
  </script>
</body>
</html>
